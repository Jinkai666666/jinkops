services:
  backend:
    # Spring Boot 後端；外部服務連線請用 .env 或環境變數提供。
    build:
      context: .
      dockerfile: Dockerfile
    image: ${BACKEND_IMAGE:-jinkops-backend:local}
    container_name: jinkops-backend
    restart: unless-stopped
    environment:
      SPRING_DATASOURCE_URL: ${SPRING_DATASOURCE_URL}
      SPRING_DATASOURCE_USERNAME: ${SPRING_DATASOURCE_USERNAME}
      SPRING_DATASOURCE_PASSWORD: ${SPRING_DATASOURCE_PASSWORD}
      SPRING_DATA_REDIS_HOST: ${SPRING_DATA_REDIS_HOST}
      SPRING_DATA_REDIS_PORT: ${SPRING_DATA_REDIS_PORT}
      SPRING_DATA_REDIS_DATABASE: ${SPRING_DATA_REDIS_DATABASE:-0}
      REDIS_URI: ${REDIS_URI}
      ELASTICSEARCH_HOST: ${ELASTICSEARCH_HOST}
      ELASTICSEARCH_PORT: ${ELASTICSEARCH_PORT}
      SPRING_RABBITMQ_HOST: ${SPRING_RABBITMQ_HOST}
      SPRING_RABBITMQ_PORT: ${SPRING_RABBITMQ_PORT}
      SPRING_RABBITMQ_USERNAME: ${SPRING_RABBITMQ_USERNAME}
      SPRING_RABBITMQ_PASSWORD: ${SPRING_RABBITMQ_PASSWORD}
      APP_JWT_SECRET: ${APP_JWT_SECRET}
      APP_JWT_EXPIRATION: ${APP_JWT_EXPIRATION:-86400000}
      SERVER_PORT: ${BACKEND_PORT:-8080}
      TZ: Asia/Shanghai
    ports:
      - "${BACKEND_PORT:-8080}:8080"

  frontend:
    # Vite 打包的靜態前端，Nginx 反代 /api 到 backend 服務。
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        VITE_API_BASE_URL: ${FRONTEND_VITE_API_BASE_URL:-/api}
    image: ${FRONTEND_IMAGE:-jinkops-frontend:local}
    container_name: jinkops-frontend
    restart: unless-stopped
    depends_on:
      - backend
    ports:
      - "${FRONTEND_PORT:-8081}:80"
